<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="manifest" href="manifest.json">
    
    <title>Reaction Timer</title>
    <style>
        /* Reset and Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #1a1a2e; 
            color: #fff; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            overflow: hidden;
            position: relative;
        }

        /* Background Layer */
        body::after {
            content: "";
            background-image: url('background.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.5; /* 50% Transparency */
            top: 0; left: 0; bottom: 0; right: 0;
            position: absolute;
            z-index: -1;
        }

        .container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; z-index: 1; }
        
        h1 { font-size: 2rem; margin-bottom: 30px; color: #4a90e2; text-shadow: 0 2px 4px #000; }

        .settings { 
            width: 100%; max-width: 400px; 
            background: rgba(0, 0, 0, 0.7); 
            padding: 20px; border-radius: 15px; 
            margin-bottom: 30px; backdrop-filter: blur(5px); 
        }

        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        input[type="number"] { 
            width: 70px; padding: 8px; border-radius: 8px; border: none; 
            background: rgba(255, 255, 255, 0.2); color: #fff; text-align: center; 
        }

        .start-btn { 
            width: 220px; height: 220px; border-radius: 50%; border: none; 
            background: linear-gradient(135deg, #4a90e2, #357abd); 
            color: white; font-size: 1.8rem; font-weight: bold; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-transform: uppercase; 
        }

        .start-btn.running { background: linear-gradient(135deg, #e2a44a, #bd8735); }
        .start-btn.waiting { background: linear-gradient(135deg, #e24a4a, #bd3535); }

        .timer { margin-top: 15px; font-size: 2.5rem; color: #e2a44a; font-family: monospace; }
        .counter { margin-top: 10px; font-size: 1.5rem; color: #4a90e2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reaction Timer</h1>
        
        <div class="settings">
            <div class="setting-row">
                <label>Interval (sec):</label>
                <input type="number" id="interval" value="10">
            </div>
            <div class="setting-row">
                <label>Warning Alert?</label>
                <input type="checkbox" id="warningEnabled">
            </div>
            <div id="warningConfig" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px; border-top: 1px solid #444; pt: 10px;">
                <div class="setting-row">
                    <span>Seconds before:</span>
                    <input type="number" id="warnSeconds" value="3">
                </div>
                <div class="setting-row">
                    <span>On Alert #:</span>
                    <input type="number" id="warnAlert" value="4">
                </div>
            </div>
        </div>

        <button class="start-btn" id="startBtn">START</button>
        <div class="counter" id="counter">Alerts: 0</div>
        <div class="timer" id="timer">00:00.0</div>
    </div>

    <script>
        let isRunning = false, timeoutId = null, audioContext = null, count = 0;
        let timerStartTime = null, timerIntervalId = null, warningTimeoutId = null;

        const startBtn = document.getElementById('startBtn');
        const intervalInput = document.getElementById('interval');
        const counterDisp = document.getElementById('counter');
        const timerDisp = document.getElementById('timer');
        const warnCheck = document.getElementById('warningEnabled');
        const warnBox = document.getElementById('warningConfig');

        warnCheck.onchange = () => warnBox.style.display = warnCheck.checked ? 'flex' : 'none';

        function playSound(freq, dur) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioContext.createOscillator(), gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.5, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + dur);
            osc.start(); osc.stop(audioContext.currentTime + dur);
        }

        function trigger(isWarning) {
            if (isWarning) {
                playSound(600, 0.3);
                if(navigator.vibrate) navigator.vibrate(300);
            } else {
                count++;
                counterDisp.textContent = `Alerts: ${count}`;
                playSound(1000, 0.5);
                if(navigator.vibrate) navigator.vibrate(500);
            }
        }

        function loop() {
            const gap = parseInt(intervalInput.value) * 1000;
            if (warnCheck.checked && (count + 1 === parseInt(document.getElementById('warnAlert').value))) {
                const leadTime = parseInt(document.getElementById('warnSeconds').value) * 1000;
                warningTimeoutId = setTimeout(() => trigger(true), gap - leadTime);
            }
            timeoutId = setTimeout(() => { trigger(false); loop(); }, gap);
        }

        startBtn.onclick = () => {
            if (!isRunning) {
                isRunning = true; count = 0; 
                startBtn.textContent = 'WAITING...'; 
                startBtn.classList.add('waiting');
                
                // Random 3-5s start delay
                timeoutId = setTimeout(() => {
                    startBtn.textContent = 'RUNNING';
                    startBtn.classList.replace('waiting', 'running');
                    timerStartTime = Date.now();
                    timerIntervalId = setInterval(() => {
                        const ms = Date.now() - timerStartTime;
                        const s = Math.floor(ms/1000), m = Math.floor(s/60);
                        timerDisp.textContent = `${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}.${Math.floor((ms%1000)/100)}`;
                    }, 100);
                    trigger(false); loop();
                }, Math.random() * 2000 + 3000);
            } else {
                isRunning = false;
                clearTimeout(timeoutId); clearTimeout(warningTimeoutId); clearInterval(timerIntervalId);
                startBtn.textContent = 'START';
                startBtn.classList.remove('running', 'waiting');
            }
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>

